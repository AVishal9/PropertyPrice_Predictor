library(tidyverse)
library(corrplot)
library(GGally)
library(scales)
library(plotly)

# Load data
house_data <- readRDS("data_processed/house_data.rds")

# Apply log transformations
house_data <- house_data %>%
  mutate(
    log_price = log1p(price),       # Log transformation for price
    log_house_size = log1p(house_size),  # Log transformation for house size
    log_land_size = log1p(land_size)  # Log transformation for land size
  )
  
# Histogram for price with x-axis scaling
ggplot(house_data, aes(x = price)) + 
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  scale_x_continuous(
    limits = c(0, 5000000), 
    breaks = seq(0, 5000000, by = 1000000), 
    labels = scales::label_dollar(scale = 1e-6, suffix = "M")
  ) +
  labs(
    title = "Distribution of House Prices",
    x = "Price (in USD)",
    y = "Count"
  ) +
  theme_minimal()

# Histogram for House Size 
ggplot(house_data, aes(x = house_size)) +
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.8) +
  labs(
    title = "Distribution of House Sizes",
    x = "House Size (sq ft)",
    y = "Count"
  ) +
  theme_minimal()
  

#Create a histogram for the log-transformed land_size  
ggplot(house_data, aes(x = log_land_size)) + 
  geom_histogram(bins = 50, fill = "purple", color = "black") +
  labs(
    title = "Distribution of Log-Transformed Land Sizes",
    x = "Log(Land Size + 1)",
    y = "Count"
  ) +
  theme_minimal()

##Correlation Matrix
# Select numeric columns for correlation
numeric_cols <- house_data %>%
  select_if(is.numeric) %>%                     
  mutate_if(is.integer, as.numeric) %>%   # Convert integers to numeric
  select(-c(h_id, street, zip_code))

numeric_cols <- numeric_cols %>%
  relocate(price, .before = everything()) # Move 'price' to the first column

# Compute correlation matrix
cor_matrix <- cor(numeric_cols, use = "pairwise.complete.obs")

# Plot correlation heatmap
corrplot(cor_matrix, method = "color", tl.cex = 0.6, 
         addCoef.col = "white", tl.col = "black")



### 1. Descriptive Statistics
# Summary statistics for numerical variables
numerical_summary <- house_data %>%
  select(log_price, log_house_size, bath, bed, log_land_size) %>%
  summarise_all(list(
    mean = ~mean(., na.rm = TRUE),
    median = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    min = ~min(., na.rm = TRUE),
    max = ~max(., na.rm = TRUE)
  ))

print(numerical_summary)

# Frequency distribution for categorical variables
categorical_summary <- house_data %>%
  select_if(is.character) %>%
  summarise_all(~list(table(.)))

print(categorical_summary)


### 2. Distribution Analysis

# Histograms for selected variables
histogram_vars <- c("log_price", "log_house_size", "log_land_size", "bath", "bed")

for (var in histogram_vars) {
  p <- ggplot(house_data, aes(x = .data[[var]])) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    labs(title = paste("Distribution of", var), x = var, y = "Count") +
    theme_minimal()
  print(p)
}

# Box plots for selected variables
for (var in histogram_vars) {
  p <- ggplot(house_data, aes(y = .data[[var]])) +
    geom_boxplot(fill = "skyblue", color = "black") +
    labs(title = paste("Box Plot of", var), y = var) +
    theme_minimal()
  print(p)
}


### 3. Feature Relationships
# Scatter plots for price vs other variables
scatter_vars <- c("house_size", "bath", "bed")

for (var in scatter_vars) {
  p <- ggplot(house_data, aes(x = .data[[var]], y = price)) +
    geom_point(alpha = 0.5, color = "blue") +
    geom_smooth(method = "lm", color = "red", se = FALSE) +
    labs(title = paste("Price vs", var), x = var, y = "Price") +
    theme_minimal()
  print(p)
}

# Pair Plots for selected numerical variables
library(GGally)

pair_plot_data <- house_data %>%
  select(price, house_size, bath, bed,land_size)

ggpairs(pair_plot_data,
        lower = list(continuous = wrap("smooth", alpha = 0.5, size = 0.2, color = "blue")),
        diag = list(continuous = wrap("densityDiag", fill = "blue", alpha = 0.4)),
        upper = list(continuous = wrap("cor", size = 3))) +
  theme_minimal() +
  ggtitle("Pairwise Relationships Between Variables")
  
# Calculate average price per state
state_avg_price <- house_data %>%
  group_by(state) %>%
  summarise(avg_price = mean(price, na.rm = TRUE))

# Assign colors based on the position in the sorted data
state_avg_price <- state_avg_price %>%
  mutate(color = case_when(
    rank(-avg_price) <= 3 ~ "red",             # Top 3 states: red
    rank(-avg_price) > (n() - 3) ~ "lightblue",  # Bottom 3 states: light blue
    TRUE ~ "grey"                             # Middle states: grey
  ))

# Bar plot of average price by state with custom colors
ggplot(state_avg_price, aes(x = avg_price, y = reorder(state, avg_price), fill = color)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Price per State", x = "Average Price (in thousands)", y = "State") +
  scale_fill_identity() +  # Use the custom colors assigned in `color`
  scale_x_continuous(labels = scales::label_comma(scale = 1e-3)) +  # Scale x-axis by 1k (in thousands)
  geom_text(aes(label = ifelse(color %in% c("red", "lightblue"), 
                               paste0("$", scales::label_comma()(avg_price)), 
                               "")), 
            hjust = -0.1, color = "black", size = 3) +  # Add labels for top 3 and bottom 3 states
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  # Rotate x-axis labels for better readability

library(tidyverse)

# Filter the data for the three states
selected_states <- house_data %>%
  filter(state %in% c("Ohio", "Texas", "California"))

# Summarize data to calculate Affordable (<50%) and Luxury (>90%) price per square foot
state_summary <- selected_states %>%
  group_by(state) %>%
  summarise(
    affordable_price_per_sqft = quantile(price_per_sqft, 0.50, na.rm = TRUE),  # 50th percentile for Affordable
    luxury_price_per_sqft = quantile(price_per_sqft, 0.90, na.rm = TRUE)      # 90th percentile for Luxury
  ) %>%
  pivot_longer(
    cols = c(affordable_price_per_sqft, luxury_price_per_sqft), 
    names_to = "category", 
    values_to = "value"
  ) %>%
  mutate(
    category = recode(category, 
                      affordable_price_per_sqft = "Affordable (<50%)", 
                      luxury_price_per_sqft = "Luxury (>90%)")
  )

# Plot the bar chart
ggplot(state_summary, aes(x = state, y = value, fill = category)) +
  geom_bar(color = "black", stat = "identity", position = "dodge", width = 0.7, alpha = 0.7) +
  labs(
    title = "Affordable vs Luxury Price per Square Foot by State",
    x = "State",
    y = "Price per Square Foot (in USD)",
    fill = "Category"
  ) +
  scale_fill_manual(values = c("Affordable (<50%)" = "darkgreen", 
                               "Luxury (>90%)" = "red")) +  # Custom colors
  theme_bw() +  # Use theme_bw for a clean, classic look
  theme(axis.text.x = element_text(size = 12, face = "bold"))
  